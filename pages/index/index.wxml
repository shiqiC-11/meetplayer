<!--index.wxml-->
<view class="page-container">
  <!-- é¡¶éƒ¨æœç´¢æ  -->
  <view class="top-bar">
    <van-search
      value="{{ searchKeyword }}"
      placeholder="æœç´¢çƒåœºæˆ–ä½ç½®"
      bind:change="onSearchChange"
      bind:search="onSearch"
    />

    <view class="filter-bar flex-between">
      <van-button size="small" icon="filter-o" bind:tap="showFilterPopup">
        ç­›é€‰
      </van-button>

      <van-button
        size="small"
        icon="{{ viewMode === 'map' ? 'bars' : 'location-o' }}"
        bind:tap="toggleViewMode"
      >
        {{ viewMode === 'map' ? 'åˆ—è¡¨' : 'åœ°å›¾' }}
      </van-button>
    </view>
  </view>

  <!-- åœ°å›¾è§†å›¾ -->
  <view wx:if="{{ viewMode === 'map' }}" class="map-container">
    <map
      id="map"
      latitude="{{ mapCenter.latitude }}"
      longitude="{{ mapCenter.longitude }}"
      scale="{{ mapScale }}"
      markers="{{ markers }}"
      bindmarkertap="onMarkerTap"
      enable-3D
      enable-overlooking
      enable-zoom
      enable-scroll
      enable-rotate
    >
      <!-- å®šä½æŒ‰é’® -->
      <cover-view class="map-control-btn" bindtap="relocate">
        <cover-image src="/assets/icons/location.jpg" class="control-icon" />
      </cover-view>
    </map>

    <!-- çƒåœºä¿¡æ¯å¡ç‰‡ï¼ˆç‚¹å‡»æ ‡è®°åæ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{ selectedVenue }}" class="venue-card-popup" bindtap="goToVenueDetail">
      <view class="venue-info">
        <text class="venue-name">{{ selectedVenue.name }}</text>
        <view class="venue-meta">
          <text class="rating">â­ {{ selectedVenue.rating.overall || 'æš‚æ— è¯„åˆ†' }}</text>
          <text class="distance">ğŸ“ {{ selectedVenue.distance }}</text>
        </view>
      </view>
      <view class="slots-preview">
        <text class="slots-count">å¼€æ”¾çº¦çƒ {{ selectedVenue.openSlotsCount || 0 }} åœº</text>
        <van-icon name="arrow" />
      </view>
    </view>
  </view>

  <!-- åˆ—è¡¨è§†å›¾ -->
  <scroll-view
    wx:else
    class="list-container"
    scroll-y
    bindscrolltolower="loadMore"
    lower-threshold="50"
  >
    <view wx:if="{{ slots.length === 0 }}" class="empty-state">
      <van-empty description="æš‚æ— çº¦çƒå±€" />
    </view>

    <view wx:else>
      <view
        wx:for="{{ slots }}"
        wx:key="_id"
        class="slot-item"
        bindtap="goToSlotDetail"
        data-id="{{ item._id }}"
      >
        <slot-card slot-data="{{ item }}" />
      </view>
    </view>

    <view wx:if="{{ loading }}" class="loading-container">
      <van-loading size="24px">åŠ è½½ä¸­...</van-loading>
    </view>
  </scroll-view>

  <!-- å‘å¸ƒçº¦çƒæµ®åŠ¨æŒ‰é’® -->
  <view class="fab" bindtap="goToPublish">
    <text class="fab-icon">+</text>
  </view>

  <!-- ç­›é€‰å¼¹çª— -->
  <van-popup
    show="{{ showFilter }}"
    position="right"
    custom-style="width: 75%; height: 100%;"
    bind:close="closeFilterPopup"
  >
    <view class="filter-popup">
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
        <van-button size="small" type="default" bind:tap="resetFilters">
          é‡ç½®
        </van-button>
      </view>

      <scroll-view class="filter-content" scroll-y>
        <!-- æ—¶é—´ç­›é€‰ -->
        <view class="filter-section">
          <text class="section-title">æ—¶é—´</text>
          <van-radio-group value="{{ filters.time }}" bind:change="onTimeChange">
            <van-radio name="today">ä»Šå¤©</van-radio>
            <van-radio name="tomorrow">æ˜å¤©</van-radio>
            <van-radio name="thisWeek">æœ¬å‘¨</van-radio>
            <van-radio name="all">å…¨éƒ¨</van-radio>
          </van-radio-group>
        </view>

        <!-- è·ç¦»ç­›é€‰ -->
        <view class="filter-section">
          <text class="section-title">è·ç¦»</text>
          <van-radio-group value="{{ filters.distance }}" bind:change="onDistanceChange">
            <van-radio name="1000">1km</van-radio>
            <van-radio name="3000">3km</van-radio>
            <van-radio name="5000">5km</van-radio>
            <van-radio name="10000">10km</van-radio>
          </van-radio-group>
        </view>

        <!-- ç­‰çº§ç­›é€‰ -->
        <view class="filter-section">
          <text class="section-title">ç­‰çº§è¦æ±‚</text>
          <van-checkbox-group value="{{ filters.levels }}" bind:change="onLevelsChange">
            <van-checkbox name="æ–°æ‰‹">æ–°æ‰‹</van-checkbox>
            <van-checkbox name="åˆçº§">åˆçº§</van-checkbox>
            <van-checkbox name="ä¸­çº§">ä¸­çº§</van-checkbox>
            <van-checkbox name="é«˜çº§">é«˜çº§</van-checkbox>
            <van-checkbox name="ä¸“ä¸š">ä¸“ä¸š</van-checkbox>
          </van-checkbox-group>
        </view>

        <!-- æ€§åˆ«ç­›é€‰ -->
        <view class="filter-section">
          <text class="section-title">æ€§åˆ«è¦æ±‚</text>
          <van-radio-group value="{{ filters.gender }}" bind:change="onGenderChange">
            <van-radio name="0">ä¸é™</van-radio>
            <van-radio name="1">ä»…ç”·</van-radio>
            <van-radio name="2">ä»…å¥³</van-radio>
          </van-radio-group>
        </view>
      </scroll-view>

      <view class="filter-footer">
        <van-button type="primary" block bind:tap="applyFilters">
          åº”ç”¨ç­›é€‰
        </van-button>
      </view>
    </view>
  </van-popup>
</view>
